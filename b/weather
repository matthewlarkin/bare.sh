#!/usr/bin/env bash
source "$(dirname "${BASH_SOURCE[0]}")/../lib/init"

doc="$(cat <<'EOF'

# weather

Get the current weather for a location

`[:location] today`		| Get today's weather
`[:location] forecast` 	| Get a three-day forecast

> weather today		| Get today's weather
> weather forecast	| Get a three-day forecast

EOF
)" && inspect "$doc" "$1"
# =============================================================================

style="text"
command="today"
color_param="T"

while (( "$#" )); do
	case "$1" in
		-C ) color_param="C" && shift ;;
		-P ) style="pretty" && shift ;;
		today|forecast ) location="$2" && command="$1" && shift 2 ;;
		-J ) command="json" && shift ;;
		* ) location="$1" && shift ;;
	esac
done

[[ $command == 'json' ]] && params="$location?format=j1"
# [[ $command == 'basic' ]] && params="$location?uQF$color&format=%c+%m+%t"
[[ $command == 'today' ]] && params="$location?u0QF$color_param"
[[ $command == 'forecast' ]] && params="$location?u3QF$color_param"

response=$(curl -sL "wttr.in/$params")

declare -A conditions
conditions=(
	["Clear"]="â˜€ï¸"
	["Sunny"]="â˜€ï¸"
	["Partly cloudy"]="â›…"
	["Cloudy"]="â˜ï¸"
	["Overcast"]="â˜ï¸"
	["Mist"]="ğŸŒ«ï¸"
	["Fog"]="ğŸŒ«ï¸"
	["Freezing fog"]="ğŸŒ«ï¸"
	["Patchy rain possible"]="ğŸŒ¦ï¸"
	["Patchy snow possible"]="ğŸŒ¨ï¸"
	["Patchy sleet possible"]="ğŸŒ¨ï¸"
	["Patchy freezing drizzle possible"]="ğŸŒ¨ï¸"
	["Thundery outbreaks possible"]="ğŸŒ©ï¸"
	["Blowing snow"]="ğŸŒ¨ï¸"
	["Blizzard"]="ğŸŒ¨ï¸"
	["Fog"]="ğŸŒ«ï¸"
	["Freezing fog"]="ğŸŒ«ï¸"
	["Patchy light drizzle"]="ğŸŒ§ï¸"
	["Light drizzle"]="ğŸŒ§ï¸"
	["Freezing drizzle"]="ğŸŒ§ï¸"
	["Heavy freezing drizzle"]="ğŸŒ§ï¸"
	["Patchy light rain"]="ğŸŒ§ï¸"
	["Light rain"]="ğŸŒ§ï¸"
	["Moderate rain at times"]="ğŸŒ§ï¸"
	["Moderate rain"]="ğŸŒ§ï¸"
	["Heavy rain at times"]="ğŸŒ§ï¸"
	["Heavy rain"]="ğŸŒ§ï¸"
	["Light freezing rain"]="ğŸŒ§ï¸"
	["Moderate or heavy freezing rain"]="ğŸŒ§ï¸"
	["Light sleet"]="ğŸŒ¨ï¸"
	["Moderate or heavy sleet"]="ğŸŒ¨ï¸"
	["Patchy light snow"]="ğŸŒ¨ï¸"
	["Light snow"]="ğŸŒ¨ï¸"
	["Patchy moderate snow"]="ğŸŒ¨ï¸"
	["Moderate snow"]="ğŸŒ¨ï¸"
	["Patchy heavy snow"]="ğŸŒ¨ï¸"
	["Heavy snow"]="ğŸŒ¨ï¸"
	["Ice pellets"]="ğŸŒ¨ï¸"
	["Light rain shower"]="ğŸŒ§ï¸"
	["Moderate or heavy rain shower"]="ğŸŒ§ï¸"
	["Torrential rain shower"]="ğŸŒ§ï¸"
	["Light sleet showers"]="ğŸŒ¨ï¸"
	["Moderate or heavy sleet showers"]="ğŸŒ¨ï¸"
	["Light snow showers"]="ğŸŒ¨ï¸"
	["Moderate or heavy snow showers"]="ğŸŒ¨ï¸"
)

[[ $style == "text" ]] && {
	# Use sed to extract the necessary details
	weather=$(echo "$response" | sed -n '1p' | cut -c 15- | xargs)
	temperature=$(echo "$response" | sed -n '2p' | cut -c 15- | xargs)
	wind=$(echo "$response" | sed -n '3p' | cut -c 15- | xargs)
	visibility=$(echo "$response" | sed -n '4p' | cut -c 15- | xargs)
	precipitation=$(echo "$response" | sed -n '5p' | cut -c 15- | xargs)

	weather_emoji=${conditions[$weather]}

	# Use emojis to represent wind, precipitation, and visibility
	echo "${weather_emoji:-$weather} ${temperature}, ğŸŒ¬ï¸ wind ${wind}. ğŸ’§ ${precipitation} / ğŸ‘€ ${visibility}"
	exit 0
} || {
	echo "$response"
	exit 0
}